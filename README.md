# æ¢é™©å®¶åä¼š | Adventurer Guild

<div align="center">
  <img src="logo.png" alt="Logo" width="200"/>
  <p>ä¸€ä¸ªç”¨äº AstrBot çš„å†’é™©è€…å…¬ä¼šä»»åŠ¡ç®¡ç†æ’ä»¶</p>
</div>

## é¡¹ç›®ç®€ä»‹

æ¢é™©å®¶åä¼šæ˜¯ä¸€ä¸ªåŸºäº AstrBot æ¡†æ¶çš„æ’ä»¶ï¼Œå®ç°äº†ç±»ä¼¼æ¸¸æˆä¸­å…¬ä¼šä»»åŠ¡ç³»ç»Ÿçš„å®Œæ•´åŠŸèƒ½ã€‚ç”¨æˆ·å¯ä»¥æ³¨å†Œä¸º**å†’é™©è€…**ï¼ˆæ¥å–ä»»åŠ¡ï¼‰æˆ–**å§”æ‰˜äºº**ï¼ˆå‘å¸ƒä»»åŠ¡ï¼‰ï¼Œé€šè¿‡è·¨å¹³å°æ¶ˆæ¯ç³»ç»Ÿï¼ˆæ”¯æŒ Telegramã€QQï¼‰å®Œæˆä»»åŠ¡å‘å¸ƒã€æ¥å–ã€æäº¤ã€ç¡®è®¤çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸã€‚

## æ ¸å¿ƒç‰¹æ€§

- **åŒè§’è‰²ç³»ç»Ÿ**ï¼šç”¨æˆ·å¯ä»¥æ³¨å†Œä¸ºå†’é™©è€…æˆ–å§”æ‰˜äººï¼Œä¸å¯ä»¥åŒæ—¶æ‹¥æœ‰ä¸¤ç§èº«ä»½
- **å®Œæ•´ä»»åŠ¡æµç¨‹**ï¼šå‘å¸ƒ â†’ æ¥å– â†’ æäº¤ â†’ ç¡®è®¤ï¼Œæ”¯æŒä»»åŠ¡çŠ¶æ€è·Ÿè¸ª
- **è·¨å¹³å°æ”¯æŒ**ï¼šé€šè¿‡ç»Ÿä¸€æ¶ˆæ¯å¯¹è±¡ï¼ˆUMOï¼‰æ”¯æŒ Telegramã€QQ ç­‰å¤šå¹³å°
- **æ™ºèƒ½æ¨é€**ï¼šæ–°ä»»åŠ¡è‡ªåŠ¨æ¨é€ç»™ç©ºé—²çŠ¶æ€çš„å†’é™©è€…
- **LLM é›†æˆ**ï¼šé€šè¿‡ `@filter.llm_tool()` è£…é¥°å™¨ï¼Œè®© AI åŠ©æ‰‹å¯ä»¥è°ƒç”¨ä»»åŠ¡æ“ä½œ
- **çŠ¶æ€ç®¡ç†**ï¼šå†’é™©è€…æ”¯æŒ IDLEã€WORKINGã€RESTã€QUIT å››ç§çŠ¶æ€
- **å†å²è®°å½•**ï¼šå®Œæ•´çš„ä»»åŠ¡åˆ†é…å†å²å’Œç³»ç»Ÿæ—¥å¿—è®°å½•
- **å¯¹è¯éš”ç¦»**ï¼šä¸ºæ¯ä¸ªç”¨æˆ·è‡ªåŠ¨åˆ›å»º"å†’é™©è€…å·¥ä¼š"ä¸“å±å¯¹è¯ï¼Œä¸æ—¥å¸¸èŠå¤©åˆ†ç¦»
- **è§’è‰²äººæ ¼è®¾å®š**ï¼šé¦–æ¬¡æ³¨å†Œæ—¶è‡ªåŠ¨ä¸ºå†’é™©è€…å’Œå§”æ‰˜äººè®¾ç½®ä¸åŒçš„ AI äººæ ¼ï¼Œæä¾›å·®å¼‚åŒ–çš„äº¤äº’ä½“éªŒ

## ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PUBLISHED  â”‚  å§”æ‰˜äººå‘å¸ƒä»»åŠ¡ï¼Œè‡ªåŠ¨æ¨é€ç»™ç©ºé—²å†’é™©è€…
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ASSIGNED   â”‚  å†’é™©è€…æ¥å–ä»»åŠ¡ï¼ŒçŠ¶æ€å˜ä¸º WORKING
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  COMPLETED  â”‚  å†’é™©è€…æäº¤ä»»åŠ¡ï¼Œç­‰å¾…å§”æ‰˜äººç¡®è®¤
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CLOSED    â”‚  å§”æ‰˜äººç¡®è®¤å®Œæˆï¼Œå†’é™©è€…çŠ¶æ€æ¢å¤ä¸º IDLE
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ¶æ„è®¾è®¡

é¡¹ç›®é‡‡ç”¨ä¸‰å±‚æ¶æ„è®¾è®¡ï¼š

### 1. æ’ä»¶å±‚ (`main.py`)
- `AssociationPlugin` ç±»å¤„ç†äº‹ä»¶è¿‡æ»¤å’Œæ¶ˆæ¯è·¯ç”±
- é€šè¿‡ `@filter.command()` æ³¨å†Œå‘½ä»¤å¤„ç†å™¨
- é€šè¿‡ `@filter.llm_tool()` æš´éœ²å·¥å…·ç»™ LLM
- ä½¿ç”¨ `send_message_to_users()` å®ç°è·¨å¹³å°æ¶ˆæ¯æ¨é€

### 2. ä¸šåŠ¡é€»è¾‘å±‚ (`engine/association_client.py`)
- `AssociationClient` ç±»å®ç°æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- å¤„ç†æ³¨å†Œã€æ¥å–ä»»åŠ¡ã€æäº¤ä»»åŠ¡ã€ç¡®è®¤ä»»åŠ¡ç­‰å·¥ä½œæµ
- åè°ƒçŠ¶æ€è½¬æ¢å’Œæ•°æ®éªŒè¯

### 3. æ•°æ®è®¿é—®å±‚ (`engine/supa_client.py`)
- `SupabaseClient` ç±»å°è£…æ‰€æœ‰æ•°æ®åº“æ“ä½œ
- æä¾›ç»Ÿä¸€çš„ CRUD æ¥å£
- ä½¿ç”¨ `_get_records()` å’Œ `_get_single_record()` è¾…åŠ©æ–¹æ³•

### 4. å·¥å…·ç±»å±‚ (`utils/`)
- **SessionManager** (`session_manager.py`)ï¼šç®¡ç†ç”¨æˆ·çš„ä¸“å±å¯¹è¯ ID
  - ç»´æŠ¤ `{unified_msg_origin: conversation_id}` æ˜ å°„å…³ç³»
  - æŒä¹…åŒ–å­˜å‚¨åˆ° `user_conversations.json` æ–‡ä»¶
  - æä¾› set/get/remove conversation ID çš„æ–¹æ³•
- **MessageUtils** (`message_utils.py`)ï¼šè·¨å¹³å°æ¶ˆæ¯å¤„ç†
  - å®ç° `send_message_to_users()` æ–¹æ³•ï¼Œæ”¯æŒä¸»åŠ¨æ¶ˆæ¯æ¨é€
  - è‡ªåŠ¨è®°å½•æ¶ˆæ¯åˆ°å¯¹è¯å†å²
  - é™„åŠ å¯¹è¯åˆ‡æ¢æç¤ºï¼Œå¼•å¯¼ç”¨æˆ·åœ¨æ­£ç¡®çš„å¯¹è¯ä¸­äº¤äº’
- **FileUtils** (`file_utils.py`)ï¼šæ–‡ä»¶ä¸‹è½½å’Œç®¡ç†

### é¢†åŸŸæ¨¡å‹ (`domain/`)
- **å€¼å¯¹è±¡** (`vo.py`)ï¼š`Adventurer`ã€`Clienter`ã€`Quest` æ•°æ®ç±»
- **çŠ¶æ€æšä¸¾** (`status.py`)ï¼š`AdventurerStatus`ã€`QuestStatus`

è¯¦ç»†çš„æ•°æ®åº“è¡¨ç»“æ„è¯·å‚é˜… [æ•°æ®åº“è¡¨ç»“æ„æ–‡æ¡£](docs/database-schema.md)ã€‚

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè¦æ±‚

- Python 3.8+
- AstrBot æ¡†æ¶
- Supabase è´¦å·å’Œé¡¹ç›®

### 2. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 3. é…ç½®æ’ä»¶

åœ¨ `_conf_schema.json` ä¸­é…ç½®ä»¥ä¸‹å‚æ•°ï¼š

```json
{
  "supabase_url": "ä½ çš„ Supabase é¡¹ç›® URL",
  "supabase_key": "ä½ çš„ Supabase API Key",
  "aiocqhttp_id": "QQ å¹³å° IDï¼ˆæœºå™¨äººåç§°ï¼‰",
  "telegram_id": "Telegram å¹³å° IDï¼ˆæœºå™¨äººåç§°ï¼‰",
  "adventurer_personality_id": "å†’é™©è€…äººæ ¼ IDï¼ˆå¯é€‰ï¼‰",
  "clienter_personality_id": "å§”æ‰˜äººäººæ ¼ IDï¼ˆå¯é€‰ï¼‰"
}
```

**é…ç½®é¡¹è¯´æ˜**ï¼š

| é…ç½®é¡¹ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| `supabase_url` | string | æ˜¯ | Supabase é¡¹ç›®çš„ API URL |
| `supabase_key` | string | æ˜¯ | Supabase é¡¹ç›®çš„ API Key |
| `aiocqhttp_id` | string | æ˜¯ | QQ å¹³å°çš„æœºå™¨äººæ ‡è¯†ï¼ˆç”¨äºè·¨å¹³å°æ¶ˆæ¯æ¨é€ï¼‰ |
| `telegram_id` | string | æ˜¯ | Telegram å¹³å°çš„æœºå™¨äººæ ‡è¯†ï¼ˆç”¨äºè·¨å¹³å°æ¶ˆæ¯æ¨é€ï¼‰ |
| `adventurer_personality_id` | string | å¦ | å†’é™©è€…äººæ ¼çš„ IDï¼Œåœ¨ AstrBot äººæ ¼ç®¡ç†ä¸­åˆ›å»º |
| `clienter_personality_id` | string | å¦ | å§”æ‰˜äººäººæ ¼çš„ IDï¼Œåœ¨ AstrBot äººæ ¼ç®¡ç†ä¸­åˆ›å»º |

### 4. æ•°æ®åº“åˆå§‹åŒ–

åœ¨ Supabase ä¸­åˆ›å»ºæ‰€éœ€çš„æ•°æ®åº“è¡¨ï¼Œè¡¨ç»“æ„è¯¦è§ [docs/database-schema.md](docs/database-schema.md)ã€‚

### 5. ï¼ˆå¯é€‰ï¼‰é…ç½®è§’è‰²äººæ ¼

ä¸ºäº†æä¾›æ›´å¥½çš„è§’è‰²æ‰®æ¼”ä½“éªŒï¼Œå»ºè®®ä¸ºå†’é™©è€…å’Œå§”æ‰˜äººé…ç½®ä¸åŒçš„ AI äººæ ¼ï¼š

1. åœ¨ AstrBot çš„"äººæ ¼ç®¡ç†"ä¸­åˆ›å»ºä¸¤ä¸ªäººæ ¼ï¼š
   - **å†’é™©è€…äººæ ¼ç¤ºä¾‹**ï¼š
     ```
     ä½ æ˜¯å†’é™©è€…å·¥ä¼šçš„æ¥å¾…å‘˜ï¼Œè´Ÿè´£å¸®åŠ©å†’é™©è€…æ¥å–å’Œå®Œæˆä»»åŠ¡ã€‚
     è¯·ç”¨å‹å¥½ã€ä¸“ä¸šçš„æ€åº¦ååŠ©å†’é™©è€…ï¼Œä½¿ç”¨é¼“åŠ±æ€§çš„è¯­è¨€ã€‚
     åœ¨äº¤æµæ—¶ï¼Œå¯ä»¥ç§°å‘¼å†’é™©è€…ä¸º"å‹‡è€…"æˆ–"å†’é™©å®¶"ã€‚
     ```
   - **å§”æ‰˜äººäººæ ¼ç¤ºä¾‹**ï¼š
     ```
     ä½ æ˜¯å†’é™©è€…å·¥ä¼šçš„ä¸šåŠ¡ä¸“å‘˜ï¼Œè´Ÿè´£å¸®åŠ©å§”æ‰˜äººå‘å¸ƒå’Œç®¡ç†ä»»åŠ¡ã€‚
     è¯·ç”¨è€å¿ƒã€ç»†è‡´çš„æ€åº¦ä¸ºå§”æ‰˜äººæœåŠ¡ï¼Œç¡®ä¿ä»»åŠ¡æè¿°æ¸…æ™°æ˜ç¡®ã€‚
     åœ¨äº¤æµæ—¶ï¼Œå¯ä»¥ç§°å‘¼å§”æ‰˜äººä¸º"å°Šæ•¬çš„å§”æ‰˜äºº"ã€‚
     ```

2. è®°å½•ä¸¤ä¸ªäººæ ¼çš„ IDï¼ˆåœ¨ AstrBot äººæ ¼ç®¡ç†é¡µé¢å¯ä»¥æŸ¥çœ‹ï¼‰

3. å°†äººæ ¼ ID å¡«å…¥æ’ä»¶é…ç½®ä¸­çš„ `adventurer_personality_id` å’Œ `clienter_personality_id` å­—æ®µ

4. é‡å¯æ’ä»¶åï¼Œæ–°æ³¨å†Œçš„ç”¨æˆ·åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶ä¼šè‡ªåŠ¨åº”ç”¨å¯¹åº”çš„äººæ ¼

### 6. å¯åŠ¨æ’ä»¶

æ’ä»¶é€šè¿‡ `@register()` è£…é¥°å™¨è‡ªåŠ¨æ³¨å†Œåˆ° AstrBotï¼Œé…ç½®å®Œæˆåé‡å¯ AstrBot å³å¯ã€‚

## ä½¿ç”¨æŒ‡å—

### å†’é™©è€…æ“ä½œ

- **æ³¨å†Œå†’é™©è€…**ï¼šé€šè¿‡ LLM å·¥å…·æˆ–å‘½ä»¤æ³¨å†Œ
- **æŸ¥çœ‹å¯ç”¨ä»»åŠ¡**ï¼š`fetch_quests_published` å·¥å…·
- **æ¥å–ä»»åŠ¡**ï¼š`accept_task` å·¥å…· + ä»»åŠ¡ ID
- **æäº¤ä»»åŠ¡**ï¼š`submit_quest` å·¥å…·
- **çŠ¶æ€ç®¡ç†**ï¼š
  - `adventurer_idle`ï¼šè®¾ç½®ä¸ºç©ºé—²çŠ¶æ€
  - `adventurer_rest`ï¼šè®¾ç½®ä¸ºä¼‘æ¯çŠ¶æ€ï¼ˆä¸æ¥æ”¶æ–°ä»»åŠ¡ï¼‰
  - `adventurer_quit`ï¼šé€€å‡ºç³»ç»Ÿ

### å§”æ‰˜äººæ“ä½œ

- **æ³¨å†Œå§”æ‰˜äºº**ï¼šé€šè¿‡ LLM å·¥å…·æˆ–å‘½ä»¤æ³¨å†Œ
- **å‘å¸ƒä»»åŠ¡**ï¼š`publish_request` å·¥å…·ï¼Œéœ€æä¾›æ ‡é¢˜ã€æè¿°ã€æŠ¥é…¬ã€æˆªæ­¢æ—¶é—´
- **ç¡®è®¤ä»»åŠ¡**ï¼š`confirm_quest` å·¥å…·ï¼Œç¡®è®¤å†’é™©è€…æäº¤çš„ä»»åŠ¡

### LLM å·¥å…·é›†æˆ

æœ¬æ’ä»¶å¤§é‡ä½¿ç”¨ LLM å·¥å…·è£…é¥°å™¨ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è‡ªç„¶è¯­è¨€ä¸ AI åŠ©æ‰‹äº¤äº’æ¥å®Œæˆä»»åŠ¡æ“ä½œã€‚ä¾‹å¦‚ï¼š

```
ç”¨æˆ·ï¼šæˆ‘æƒ³å‘å¸ƒä¸€ä¸ªä»»åŠ¡ï¼Œæ ‡é¢˜æ˜¯"å¯»æ‰¾å¤±è½çš„å®çŸ³"ï¼ŒæŠ¥é…¬ 100 é‡‘å¸ï¼Œæˆªæ­¢æ—¶é—´ä¸‹å‘¨äº”
AIï¼šï¼ˆè°ƒç”¨ publish_request å·¥å…·ï¼‰
```

## è§’è‰²äººæ ¼ç³»ç»Ÿ

### å·¥ä½œåŸç†

å½“ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨"æˆ‘è¦å½“å†’é™©è€…"æˆ–"æˆ‘è¦æˆä¸ºå§”æ‰˜äºº"å‘½ä»¤æ—¶ï¼Œæ’ä»¶ä¼šè‡ªåŠ¨ï¼š

1. åˆ›å»ºä¸“å±çš„"å†’é™©è€…å·¥ä¼š"å¯¹è¯ï¼ˆconversationï¼‰
2. æ ¹æ®æ³¨å†Œçš„è§’è‰²ç±»å‹ï¼Œè®¾ç½®ç›¸åº”çš„äººæ ¼ï¼ˆpersonaï¼‰ï¼š
   - å†’é™©è€… â†’ åº”ç”¨ `adventurer_personality_id` å¯¹åº”çš„äººæ ¼
   - å§”æ‰˜äºº â†’ åº”ç”¨ `clienter_personality_id` å¯¹åº”çš„äººæ ¼

### æŠ€æœ¯å®ç°

äººæ ¼è®¾ç½®é€šè¿‡ AstrBot çš„ `ConversationManager` API å®ç°ï¼š

```python
# main.py:147-149 (å†’é™©è€…)
await self.context.conversation_manager.update_conversation(
    event.unified_msg_origin, cid, persona_id=adventurer_personality_id
)

# main.py:162-164 (å§”æ‰˜äºº)
await self.context.conversation_manager.update_conversation(
    event.unified_msg_origin, cid, persona_id=clienter_personality_id
)
```

### äººæ ¼æŒä¹…åŒ–

- äººæ ¼è®¾ç½®åœ¨é¦–æ¬¡æ³¨å†Œæ—¶åº”ç”¨ï¼Œä¹‹åä¼šæŒä¹…åŒ–åˆ°å¯¹è¯æ•°æ®ä¸­
- å³ä½¿ç”¨æˆ·åˆ‡æ¢åˆ°å…¶ä»–å¯¹è¯åå†å›æ¥ï¼Œäººæ ¼è®¾å®šä¾ç„¶æœ‰æ•ˆ
- å¦‚éœ€æ›´æ¢äººæ ¼ï¼Œå¯ä»¥åœ¨ AstrBot çš„å¯¹è¯ç®¡ç†ä¸­æ‰‹åŠ¨ä¿®æ”¹

## è·¨å¹³å°æ¶ˆæ¯ç³»ç»Ÿ

æ’ä»¶é€šè¿‡ `send_message_to_users()` æ–¹æ³•å®ç°è·¨å¹³å°æ¶ˆæ¯æ¨é€ï¼š

1. æ ¹æ®ç”¨æˆ·çš„ `contact_way` å’Œ `contact_number` æ„å»ºç»Ÿä¸€æ¶ˆæ¯å¯¹è±¡ï¼ˆUMOï¼‰
2. æ ¼å¼ï¼š`{platform_id}:FriendMessage:{contact_number}`
3. æ”¯æŒä»»åŠ¡é€šçŸ¥è‡ªåŠ¨å‘é€åˆ°ç”¨æˆ·æ‰€åœ¨çš„å¹³å°ï¼ˆTelegram æˆ– QQï¼‰

## ç”¨æˆ·èº«ä»½è¯†åˆ«

ç³»ç»Ÿé€šè¿‡æ¶ˆæ¯äº‹ä»¶ä¸­çš„ä»¥ä¸‹ä¿¡æ¯è¯†åˆ«ç”¨æˆ·ï¼š

- `name`ï¼šæ¥è‡ª `event.get_sender_name()`
- `contact_way`ï¼šå¹³å°åç§°ï¼Œå¦‚ "telegram"ã€"aiocqhttp"
- `contact_number`ï¼šå¹³å°ç”¨æˆ· ID

æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢ä½¿ç”¨ `(contact_way, contact_number)` ä½œä¸ºå¤åˆé”®ã€‚

## å¯¹è¯ç®¡ç†æœºåˆ¶ï¼ˆConversation IDï¼‰

### ä¸ºä»€ä¹ˆéœ€è¦ä¸“å±å¯¹è¯ï¼Ÿ

æ’ä»¶ä¸ºæ¯ä¸ªç”¨æˆ·è‡ªåŠ¨åˆ›å»ºä¸€ä¸ª"å†’é™©è€…å·¥ä¼š"ä¸“å±å¯¹è¯ï¼ˆconversationï¼‰ï¼Œä¸ç”¨æˆ·çš„æ—¥å¸¸èŠå¤©å®Œå…¨éš”ç¦»ã€‚è¿™æ ·åšçš„å¥½å¤„ï¼š

1. **ä¸Šä¸‹æ–‡éš”ç¦»**ï¼šå·¥ä¼šä»»åŠ¡ç›¸å…³çš„å¯¹è¯ä¸ä¼šå¹²æ‰°æ—¥å¸¸èŠå¤©çš„ LLM ä¸Šä¸‹æ–‡
2. **å†å²è®°å½•åˆ†ç¦»**ï¼šä»»åŠ¡æ“ä½œå’Œæ—¥å¸¸å¯¹è¯å„è‡ªä¿ç•™ç‹¬ç«‹çš„å†å²è®°å½•
3. **å¤šä»»åŠ¡ç®¡ç†**ï¼šç”¨æˆ·å¯ä»¥åœ¨ä¸åŒå¯¹è¯é—´è‡ªç”±åˆ‡æ¢ï¼Œä¸€ä¸ªç”¨äºå·¥ä¼šä»»åŠ¡ï¼Œä¸€ä¸ªç”¨äºæ—¥å¸¸äº¤æµ

### Conversation ID çš„ç”Ÿå‘½å‘¨æœŸ

#### 1. è‡ªåŠ¨åˆ›å»ºä¸“å±å¯¹è¯

å½“ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æˆ– LLM å·¥å…·æ—¶ï¼Œæ’ä»¶ä¼šè‡ªåŠ¨åˆ›å»ºä¸“å±å¯¹è¯ï¼š

- å‘½ä»¤è§¦å‘ï¼š`/æˆ‘è¦å½“å†’é™©è€…`ã€`/æˆ‘è¦æˆä¸ºå§”æ‰˜äºº`
- LLM å·¥å…·è§¦å‘ï¼š`publish_request`ã€`fetch_quests_published`ã€`accept_task` ç­‰

åˆ›å»ºè¿‡ç¨‹ç”± `_ensure_guild_conversation()` æ–¹æ³•å¤„ç†ï¼š

```python
# main.py:77-80
async def _ensure_guild_conversation(event: AstrMessageEvent) -> tuple[bool, str]:
    """ç¡®ä¿ç”¨æˆ·åœ¨å†’é™©è€…å·¥ä¼šä¸“å±å¯¹è¯ä¸­

    Returns:
        tuple[bool, str]: (is_first_time, conversation_id)
    """
```

é¦–æ¬¡åˆ›å»ºæ—¶ï¼Œç”¨æˆ·ä¼šæ”¶åˆ°æç¤ºä¿¡æ¯ï¼š

```
âœ¨ å·²ä¸ºæ‚¨åˆ›å»ºå†’é™©è€…å·¥ä¼šä¸“å±å¯¹è¯ï¼ˆabcd1234...ï¼‰
æ‰€æœ‰å·¥ä¼šç›¸å…³çš„å¯¹è¯éƒ½ä¼šåœ¨è¿™ä¸ªä¸“å±ç©ºé—´ä¸­è¿›è¡Œã€‚
å¦‚éœ€åˆ‡æ¢å›æ—¥å¸¸èŠå¤©ï¼Œè¯·ä½¿ç”¨ /ls æŸ¥çœ‹å¯¹è¯åˆ—è¡¨ï¼Œç„¶åç”¨ /switch åºå· åˆ‡æ¢ã€‚
```

#### 2. Conversation ID æŒä¹…åŒ–å­˜å‚¨

ä¸“å±å¯¹è¯çš„ ID é€šè¿‡ `SessionManager` ç®¡ç†ï¼š

- **å­˜å‚¨ä½ç½®**ï¼š`{SAVE_DIR}/user_conversations.json`
- **æ•°æ®æ ¼å¼**ï¼š`{"unified_msg_origin": "conversation_id"}`
- **è‡ªåŠ¨åŠ è½½**ï¼šæ’ä»¶å¯åŠ¨æ—¶è‡ªåŠ¨ä»æ–‡ä»¶åŠ è½½æ˜ å°„å…³ç³»

ç¤ºä¾‹æ•°æ®ï¼š

```json
{
  "aiocqhttp:FriendMessage:123456": "550e8400-e29b-41d4-a716-446655440000",
  "telegram:FriendMessage:789012": "6ba7b810-9dad-11d1-80b4-00c04fd430c8"
}
```

#### 3. å¯¹è¯åˆ‡æ¢æç¤º

å½“æ’ä»¶å‘ç”¨æˆ·ä¸»åŠ¨å‘é€æ¶ˆæ¯ï¼ˆå¦‚ä»»åŠ¡é€šçŸ¥ï¼‰æ—¶ï¼Œä¼šè‡ªåŠ¨é™„åŠ å¯¹è¯åˆ‡æ¢æç¤ºï¼š

```
[ä»»åŠ¡é€šçŸ¥å†…å®¹]

ğŸ’¬ å¦‚éœ€å›å¤ï¼Œè¯·å…ˆåˆ‡æ¢åˆ°å†’é™©è€…å·¥ä¼šå¯¹è¯ï¼š
   1. ä½¿ç”¨ /ls æŸ¥çœ‹å¯¹è¯åˆ—è¡¨
   2. æ‰¾åˆ°ã€Œå†’é™©è€…å·¥ä¼š(abcd)ã€å¯¹è¯
   3. ä½¿ç”¨ /switch åºå· è¿›è¡Œåˆ‡æ¢
```

è¿™ä¸ªåŠŸèƒ½ç”± `MessageUtils._build_message_with_switch_notice()` å®ç°ã€‚

#### 4. æ¶ˆæ¯è®°å½•åˆ°å¯¹è¯å†å²

æ‰€æœ‰ä¸»åŠ¨å‘é€çš„æ¶ˆæ¯éƒ½ä¼šè¢«è®°å½•åˆ°ä¸“å±å¯¹è¯çš„å†å²ä¸­ï¼š

```python
# utils/message_utils.py:153
async def _record_message_to_conversation(self, umo: str, message: str) -> None:
    """å°†ä¸»åŠ¨å‘é€çš„æ¶ˆæ¯è®°å½•åˆ°ç”¨æˆ·çš„é»˜è®¤å¯¹è¯å†å²ä¸­"""
```

è¿™ç¡®ä¿äº† LLM å¯ä»¥çœ‹åˆ°å®Œæ•´çš„ä»»åŠ¡äº¤äº’ä¸Šä¸‹æ–‡ã€‚

### Unified Message Origin (UMO)

UMO æ˜¯ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œæ ¼å¼ä¸ºï¼š`{platform_id}:{message_type}:{user_id}`

ç¤ºä¾‹ï¼š
- QQ ç”¨æˆ·ï¼š`aiocqhttp:FriendMessage:123456789`
- Telegram ç”¨æˆ·ï¼š`telegram:FriendMessage:987654321`

SessionManager ä½¿ç”¨ UMO ä½œä¸ºé”®æ¥å­˜å‚¨æ¯ä¸ªç”¨æˆ·çš„ä¸“å± conversation IDã€‚

### ç›¸å…³ä»£ç ä½ç½®

- **å¯¹è¯åˆ›å»º**ï¼š`main.py:_ensure_guild_conversation()` (77è¡Œ)
- **å¯¹è¯ç®¡ç†**ï¼š`utils/session_manager.py:SessionManager`
- **æ¶ˆæ¯å¤„ç†**ï¼š`utils/message_utils.py:MessageUtils`
- **å¯¹è¯åˆ‡æ¢æç¤º**ï¼š`main.py:_create_first_time_notice()` (121è¡Œ)

## å¼€å‘æŒ‡å—

### ç›®å½•ç»“æ„

```
.
â”œâ”€â”€ main.py                    # æ’ä»¶ä¸»æ–‡ä»¶ï¼ˆæ’ä»¶å±‚ï¼‰
â”œâ”€â”€ engine/
â”‚   â”œâ”€â”€ association_client.py  # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â””â”€â”€ supa_client.py         # æ•°æ®è®¿é—®å±‚
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ vo.py                  # å€¼å¯¹è±¡å®šä¹‰
â”‚   â””â”€â”€ status.py              # çŠ¶æ€æšä¸¾
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ session_manager.py     # å¯¹è¯ä¼šè¯ç®¡ç†
â”‚   â”œâ”€â”€ message_utils.py       # æ¶ˆæ¯å¤„ç†å·¥å…·
â”‚   â””â”€â”€ file_utils.py          # æ–‡ä»¶å¤„ç†å·¥å…·
â”œâ”€â”€ handlers/
â”‚   â”œâ”€â”€ command_handlers.py    # å‘½ä»¤å¤„ç†å™¨
â”‚   â”œâ”€â”€ llm_handlers.py        # LLM å·¥å…·å¤„ç†å™¨
â”‚   â””â”€â”€ event_handlers.py      # äº‹ä»¶å¤„ç†å™¨
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ database-schema.md     # æ•°æ®åº“è¡¨ç»“æ„æ–‡æ¡£
â”œâ”€â”€ metadata.yaml              # æ’ä»¶å…ƒæ•°æ®
â”œâ”€â”€ _conf_schema.json          # é…ç½®æ¨¡æ¿
â””â”€â”€ requirements.txt           # Python ä¾èµ–
```

### å¼€å‘æ³¨æ„äº‹é¡¹

- å§‹ç»ˆåœ¨åŒä¸€äº‹åŠ¡ä¸­æ›´æ–°ä»»åŠ¡çŠ¶æ€å’Œç›¸å…³å®ä½“çŠ¶æ€ï¼ˆå¦‚å†’é™©è€…çŠ¶æ€ï¼‰
- ä½¿ç”¨ `Quest.format_quests()` è¿›è¡Œç»Ÿä¸€çš„ä»»åŠ¡åˆ—è¡¨æ ¼å¼åŒ–
- ä¸šåŠ¡éªŒè¯åœ¨ `AssociationClient` å±‚å®Œæˆï¼Œ`SupabaseClient` å±‚åªè´Ÿè´£æ•°æ®æ“ä½œ
- é”™è¯¯æ—¥å¿—ä½¿ç”¨ `astrbot.api.logger`ï¼Œä¸ä½¿ç”¨æ ‡å‡† Python logging
- æ‰€æœ‰ ID ä½¿ç”¨ `uuid.uuid4()` ç”Ÿæˆ
- æ—¶é—´å­—æ®µä½¿ç”¨ `datetime.fromisoformat()` è§£æå’Œ `.strftime('%Y-%m-%d %H:%M:%S')` åºåˆ—åŒ–
- **å¯¹è¯ç®¡ç†ç›¸å…³**ï¼š
  - æ‰€æœ‰å‘½ä»¤å’Œ LLM å·¥å…·å¿…é¡»è°ƒç”¨ `_ensure_guild_conversation()` ç¡®ä¿ç”¨æˆ·åœ¨ä¸“å±å¯¹è¯ä¸­
  - `SessionManager` åœ¨æ’ä»¶åˆå§‹åŒ–æ—¶åˆ›å»ºï¼Œç”¨äºæŒä¹…åŒ–å­˜å‚¨ç”¨æˆ·çš„ conversation ID
  - ä¸»åŠ¨å‘é€æ¶ˆæ¯æ—¶ä½¿ç”¨ `MessageUtils.send_message_to_users()`ï¼Œä¼šè‡ªåŠ¨è®°å½•åˆ°å¯¹è¯å†å²å¹¶é™„åŠ åˆ‡æ¢æç¤º
  - UMOï¼ˆunified_msg_originï¼‰æ ¼å¼ï¼š`{platform_id}:{message_type}:{user_id}`ï¼Œæ˜¯ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ç¬¦

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ [LICENSE](LICENSE) è®¸å¯è¯ã€‚

## ä½œè€…

Orlando

## å¸¸è§é—®é¢˜

### ä¸­æ–‡ä»»åŠ¡æ ‡é¢˜å’Œæè¿°å‡ºç°æ–‡å­—æ›¿æ¢é—®é¢˜

**ç°è±¡**ï¼šå‘å¸ƒä»»åŠ¡æ—¶ï¼Œä¸­æ–‡æ–‡æœ¬è¢«æ›¿æ¢æˆå…¶ä»–æ±‰å­—ï¼Œä¾‹å¦‚ï¼š
- è¾“å…¥ï¼š`"å¯»æ‰¾å¤±è½çš„å®è—"`
- å®é™…ä¿å­˜ï¼š`"æœç´¢å¤±è¼ƒçš„å­˜è´§"`

**åŸå› **ï¼šè¿™æ˜¯ LLM åœ¨ç”Ÿæˆå·¥å…·è°ƒç”¨å‚æ•°æ—¶çš„ token é€‰æ‹©é—®é¢˜ï¼ˆä¸æ˜¯ç¼–ç é—®é¢˜ï¼‰ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **ç«‹å³æœ‰æ•ˆ**ï¼šåœ¨ AstrBot çš„ Provider é…ç½®ä¸­å°† `temperature` è®¾ç½®ä¸º `0.0`
2. **è¡¥å……æªæ–½**ï¼šåœ¨ System Prompt ä¸­æ·»åŠ "è°ƒç”¨å·¥å…·æ—¶å¿…é¡»ç²¾ç¡®æå–ç”¨æˆ·åŸæ–‡"çš„çº¦æŸ
3. **é•¿æœŸæ–¹æ¡ˆ**ï¼šå¦‚é—®é¢˜æŒç»­ï¼Œè€ƒè™‘åˆ‡æ¢åˆ°å¯¹ä¸­æ–‡æ”¯æŒæ›´å¥½çš„æ¨¡å‹ï¼ˆå¦‚ GPT-4ã€Claude 3.5ã€Qwen2.5-72B+ï¼‰

è¯¦ç»†è¯´æ˜å’Œè¯Šæ–­æ­¥éª¤è¯·å‚è€ƒï¼š[ä¿®å¤ä¸­æ–‡æ–‡æœ¬æ›¿æ¢é—®é¢˜æŒ‡å—](docs/fix-chinese-garbling.md)

## ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“è¡¨ç»“æ„](docs/database-schema.md)
- [ä¿®å¤ä¸­æ–‡æ–‡æœ¬æ›¿æ¢é—®é¢˜](docs/fix-chinese-garbling.md)
- [æŠ€æœ¯è¯Šæ–­æŠ¥å‘Š](docs/encoding-issue-diagnosis.md)